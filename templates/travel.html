{% extends "base.html" %}
{% set title = "여행툴" %}
{% set active = "travel" %}

{% block content %}
  <!-- 기존 travel.html의 내용(폼/결과 테이블)을 여기 안으로 그대로 붙여넣기 -->



<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>여행 툴 | 항공 + 호텔 최저가</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --shadow2: 0 6px 18px rgba(17,24,39,.08);
      --radius:18px;
      --accent:#2563eb;
      --accent2:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: "NanumSquareNeo",ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", sans-serif;
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1100px; margin:0 auto; padding:22px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:18px;
    }
    .brand{display:flex; gap:10px; align-items:center; font-weight:800;}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);}
    .tabs{
      display:flex; gap:10px;
      background:rgba(255,255,255,.7);
      border:1px solid var(--line);
      padding:6px; border-radius:999px;
      box-shadow: var(--shadow2);
    }
    .tab{
      padding:8px 12px; border-radius:999px; font-weight:700; color:var(--muted);
    }
    .tab.active{background:var(--card); color:var(--text); border:1px solid var(--line);}
    .hero{
      display:grid; grid-template-columns: 1.3fr .9fr;
      gap:16px; margin-bottom:16px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .hero h1{margin:0 0 8px 0; font-size:24px;}
    .hero p{margin:0; color:var(--muted); line-height:1.5;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#eff6ff; color:#1d4ed8; border:1px solid #dbeafe;
      padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px;
      margin-top:12px;
    }
    .pill .mini{width:8px;height:8px;border-radius:999px;background:var(--accent);}
    .card-title{font-weight:900; margin-bottom:10px;}
    .rows{display:grid; gap:10px;}
    .row{display:flex; align-items:center; justify-content:space-between; padding:10px 12px;
      border:1px dashed var(--line); border-radius:14px; background:#fafafa;
    }
    .muted{color:var(--muted); font-weight:700;}
    .chip{
      display:inline-flex; align-items:center;
      padding:4px 10px; border-radius:999px;
      border:1px solid var(--line); background:#fff; font-weight:800; font-size:12px;
    }
    .mini-kpis{
      display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:12px;
    }
    .kpi{border:1px solid var(--line); border-radius:14px; padding:10px; background:#fff;}
    .kpi-num{font-weight:900;}
    .kpi-label{color:var(--muted); font-size:12px; margin-top:4px;}

    form{margin-top:12px;}
    fieldset{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fff;
      margin:12px 0;
    }
    legend{padding:0 8px; font-weight:900; color:#111827;}
    label{display:inline-flex; align-items:center; gap:8px; margin:6px 10px 6px 0;}
    input, select{
      padding:9px 10px; border-radius:12px;
      border:1px solid var(--line); background:#fff; color:var(--text);
      outline:none;
    }
    input:focus, select:focus{border-color:#bfdbfe; box-shadow:0 0 0 3px rgba(37,99,235,.12);}
    .btn{
      padding:10px 14px; border-radius:14px; border:1px solid #bfdbfe;
      background:linear-gradient(180deg,#eff6ff,#ffffff);
      font-weight:900; cursor:pointer;
    }
    .btn:hover{transform:translateY(-1px)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .grid3{display:grid; grid-template-columns:repeat(3,1fr); gap:10px;}
    .helper{color:var(--muted); font-size:12px; margin-top:6px;}

    table{border-collapse:collapse; width:100%; margin-top:10px; background:#fff; border-radius:14px; overflow:hidden; border:1px solid var(--line);}
    th, td{border-bottom:1px solid var(--line); padding:10px 10px; font-size:0.92rem;}
    th{background:#f9fafb; text-align:left;}
    tr:last-child td{border-bottom:none;}
    .right{text-align:right;}
    .section-title{margin:18px 0 8px; font-size:18px;}
    .error{color:#b91c1c; background:#fef2f2; border:1px solid #fecaca; padding:10px 12px; border-radius:14px;}

    /* mode toggle */
    .mode-box{display:flex; gap:10px; flex-wrap:wrap}
    .mode-item{
      display:flex; gap:8px; align-items:center;
      padding:8px 10px; border:1px solid var(--line);
      border-radius:999px; background:#fff; font-weight:800;
    }
    .hidden{display:none !important;}
    @media (max-width: 920px){
      .hero{grid-template-columns:1fr;}
      .grid2,.grid3{grid-template-columns:1fr;}
    }
  

    /* ===== Autocomplete / Catalog ===== */
    .input-with-btn{ display:flex; gap:8px; align-items:center; }
    .btn.mini{ padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900; }
    .code-help{ margin-top:6px; color: var(--muted); font-size:12px; line-height:1.35; }

    /* Modal */
    .modal-overlay{
      position:fixed; inset:0; background: rgba(8,20,40,.35);
      display:flex; align-items:center; justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modal{
      width: min(920px, 100%);
      background: #fff;
      border: 1px solid var(--line, #e3ebf7);
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(10,25,60,.18);
      overflow:hidden;
    }
    .modal-head{
      display:flex; align-items:center; gap:10px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--line, #e3ebf7);
      background: linear-gradient(180deg, #f3f8ff, #ffffff);
    }
    .modal-title{ font-weight:950; }
    .modal-close{ margin-left:auto; }
    .modal-body{ padding: 12px 16px 16px; }
    .modal-tabs{
      display:flex; gap:8px; padding: 6px;
      border: 1px solid var(--line, #e3ebf7);
      border-radius: 999px;
      background: rgba(245,248,255,.8);
      width: fit-content;
    }
    .modal-tab{
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      border: 1px solid transparent;
      background: transparent;
      cursor:pointer;
      color: var(--muted, #5b6b80);
    }
    .modal-tab.active{
      background: rgba(7,112,227,.10);
      border-color: rgba(7,112,227,.22);
      color: #0770e3;
    }
    .catalog-search{ display:flex; gap:10px; margin-top: 12px; }
    .catalog-search input{
      flex:1;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line, #e3ebf7);
      background: #f7fbff;
    }
    .catalog-table{
      margin-top: 12px;
      border: 1px solid var(--line, #e3ebf7);
      border-radius: 14px;
      overflow:auto;
      max-height: 420px;
    }
    .catalog-table table{ width:100%; border-collapse:collapse; min-width: 640px; }
    .catalog-table th, .catalog-table td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--line, #e3ebf7);
      font-size: 13px;
    }
    .catalog-table th{
      position: sticky; top:0; z-index:1;
      background: linear-gradient(180deg, #f3f8ff, #eaf2ff);
      color: #24415f;
      text-align:left;
    }
    .catalog-table tr:hover td{ background: rgba(7,112,227,.04); cursor:pointer; }


    /* ===== Advanced settings (Top N / Limit) ===== */
    details.advanced{
      margin-top: 14px;
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 10px 12px;
      background: rgba(255,255,255,.9);
      box-shadow: var(--shadow-sm);
    }
    details.advanced summary{
      cursor: pointer;
      font-weight: 900;
      color: var(--ink);
      user-select: none;
      list-style: none;
      outline: none;
    }
    details.advanced summary::-webkit-details-marker{ display:none; }
    details.advanced summary::after{
      content: "▾";
      float: right;
      color: var(--muted);
      font-weight: 900;
      transform: translateY(-1px);
    }
    details.advanced[open] summary::after{ content:"▴"; }
    .advanced-grid{ margin-top: 12px; }
    .advanced-grid .hint{
      grid-column: 1 / -1;
      font-size: 12px;
      line-height: 1.4;
      opacity: .9;
      padding-top: 2px;
    }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><span class="dot"></span> 여행 자동화</div>
      <div class="tabs">
        <a class="tab" href="/">소개</a>
        <a class="tab active" href="/travel{% if current_key %}?key={{ current_key }}{% endif %}">여행툴</a>
      </div>
    </div>

    <section class="hero">
      <div class="card">
        <h1>항공 + 호텔 최저가 웹툴</h1>
        <p>
          호텔은 LiteAPI, 항공은 fast-flights 기반으로 <b>기간/한달 스캔</b>을 지원해.
          아래에서 모드 선택하고 바로 검색해봐.
        </p>
        <div class="pill"><span class="mini"></span> Tip: 모드에 따라 입력칸이 자동으로 바뀜</div>

        {% if has_access_key %}
          <div class="helper">ACCESS_KEY가 설정돼 있으면, 아래 key 입력(또는 URL ?key=...)이 필요해.</div>
        {% endif %}
      </div>

      <!-- 너가 준 hero-right 카드: "글자만" 느낌 개선 -->
      <div class="card">
        <div class="card-title">사이트 구성</div>
        <div class="rows">
          <div class="row">
            <div><span class="muted">소개</span></div>
            <div class="chip">/</div>
          </div>
          <div class="row">
            <div><span class="muted">여행툴</span></div>
            <div class="chip">/travel</div>
          </div>
        </div>

        <div class="mini-kpis">
          <div class="kpi">
            <div class="kpi-num">소개</div>
            <div class="kpi-label">간단한 자기 소개</div>
          </div>
          <div class="kpi">
            <div class="kpi-num">프로젝트</div>
            <div class="kpi-label">만들어온/만들어갈 것</div>
          </div>
          <div class="kpi">
            <div class="kpi-num">Contact</div>
            <div class="kpi-label">연락 주세요</div>
          </div>
        </div>
      </div>
    </section>

    <div class="card">
      <form method="post" class="form">
        {% if has_access_key %}
          <label>key: <input name="key" value="{{ current_key }}" placeholder="ACCESS_KEY"></label>
        {% endif %}

        <fieldset>
          <legend>검색 모드</legend>
          <div class="mode-box">
            <!-- ✅ 순서 변경: 호텔(기간) → 호텔(한달) → 항공+호텔(기간) → 항공+호텔(한달) -->
            <label class="mode-item"><input type="radio" name="mode" value="hotel_period" {{ 'checked' if mode == 'hotel_period' else '' }}> 호텔 최저가 (여행기간)</label>
            <label class="mode-item"><input type="radio" name="mode" value="hotel_month" {{ 'checked' if mode == 'hotel_month' else '' }}> 호텔 최저가 (한달)</label>
            <label class="mode-item"><input type="radio" name="mode" value="flight_hotel_period" {{ 'checked' if mode == 'flight_hotel_period' else '' }}> 항공 + 호텔 (여행기간)</label>
            <label class="mode-item"><input type="radio" name="mode" value="flight_hotel_month" {{ 'checked' if mode == 'flight_hotel_month' else '' }}> 항공 + 호텔 (한달)</label>
          </div>
        </fieldset>

        <fieldset>
          <legend>호텔 공통 설정</legend>

          <div class="grid3">
            <label>도시 (cityName)
              <input name="city" value="{{ city }}">
            </label>

            <label>국가코드 (countryCode)
              <div class="input-with-btn">
                <input name="country" id="country" list="country-list" value="{{ country }}" placeholder="예: KR">
                <button type="button" class="btn ghost mini" onclick="openCatalog('country','country')">찾기</button>
              </div>
              <div class="code-help">국가 2자리 코드(ISO). 예: KR(한국), JP(일본), US(미국) — 아래 목록에서 검색해서 바로 넣을 수 있어.</div>
            </label>

            <label>성인 인원수
              <input name="adults" value="{{ adults }}">
            </label>
          </div>

          <div class="grid4" style="margin-top:12px;">
            <label>최소 성급
              <input name="min_stars" value="{{ min_stars }}">
            </label>

            <label>최대 성급
              <input name="max_stars" value="{{ max_stars }}">
            </label>

            <label>통화
              <input name="currency" value="{{ currency }}">
            </label>

            <label>국적
              <input name="guest_nat" value="{{ guest_nat }}">
            </label>
          </div>
        </fieldset>

        <fieldset id="fs-period">
          <legend>여행기간 입력</legend>
          <div class="grid4">
            <label>체크인
              <input type="date" name="checkin" value="{{ checkin }}" required>
            </label>
            <label>체크아웃
              <input type="date" name="checkout" value="{{ checkout }}" required>
            </label>
<<<<<<< HEAD
</div>
=======
            <label>표시 개수
              <input name="top_n" value="{{ top_n }}">
            </label>
            <label>검색 개수
              <input name="limit" value="{{ limit }}">
              
            </label>
</div>
        </fieldset>


        <fieldset id="fs-month">
          <legend>한달 스캔 입력</legend>
          <div class="grid3">
            <label>기준 연도 <input name="year" value="{{ year }}" size="5"></label>
            <label>기준 월 <input name="month" value="{{ month }}" size="3"></label>
            <label>숙박일수(박) <input name="nights" value="{{ nights }}" size="3"></label>
          </div>
        </fieldset>


        <details class="advanced">
          <summary>고급 설정 (표시/검색 개수)</summary>
          <div class="grid3 advanced-grid">
            <label>표시 개수 (Top N)
              <input name="top_n" value="{{ top_n }}" inputmode="numeric">
            </label>
            <label>검색 개수 (Limit)
              <input name="limit" value="{{ limit }}" inputmode="numeric">
            </label>
            <div class="hint muted">
              Top N은 화면에 보여줄 결과 개수, Limit은 API에서 가져올 후보(검색) 개수입니다.
            </div>
          </div>
        </details>



        <fieldset id="fs-flight">
          <legend>항공 설정 (항공+호텔 모드에서 사용)</legend>
          <div class="grid3">
            <label>출발(IATA)
              <div class="input-with-btn">
                <input name="origin" id="origin" list="airport-list" value="{{ origin }}" placeholder="예: ICN" size="8">
                <button type="button" class="btn ghost mini" onclick="openCatalog('airport','origin')">찾기</button>
              </div>
              <div class="code-help">예: ICN(인천), GMP(김포), NRT(도쿄 나리타)… 검색해서 바로 입력 가능.</div>
            </label>
            <label>도착(IATA)
              <div class="input-with-btn">
                <input name="dest" id="dest" list="airport-list" value="{{ dest }}" placeholder="예: NRT" size="8">
                <button type="button" class="btn ghost mini" onclick="openCatalog('airport','dest')">찾기</button>
              </div>
            </label>
            <label>항공 인원 <input name="flight_adults" value="{{ flight_adults }}" size="3"></label>
          </div>
          <div class="grid3">
            <label>여정
              <select name="trip">
                <option value="round-trip" {% if trip == 'round-trip' %}selected{% endif %}>왕복</option>
                <option value="one-way" {% if trip == 'one-way' %}selected{% endif %}>편도</option>
              </select>
            </label>
            <label>좌석
              <select name="seat">
                <option value="economy" {% if seat == 'economy' %}selected{% endif %}>Economy</option>
                <option value="premium_economy" {% if seat == 'premium_economy' %}selected{% endif %}>Premium Economy</option>
                <option value="business" {% if seat == 'business' %}selected{% endif %}>Business</option>
                <option value="first" {% if seat == 'first' %}selected{% endif %}>First</option>
              </select>
            </label>
            <label>호텔 표시 개수 <input name="fh_top_n" value="{{ fh_top_n }}" size="3"></label>
          </div>
          <div class="helper">
            “항공+호텔(여행기간)”은 위의 체크인/체크아웃을 항공 날짜로 그대로 사용해.
          </div>
        </fieldset>

        <button class="btn" type="submit">검색하기</button>
        <datalist id="country-list"></datalist>
  <datalist id="airport-list"></datalist>
</form>

      {% if error %}
        <div class="error" style="margin-top:12px;">에러: {{ error }}</div>
      {% endif %}

      <!-- 결과: 호텔(여행기간) -->
      {% if mode == 'hotel_period' and period_rows %}
        <h2 class="section-title">호텔 최저가 (여행기간) 결과</h2>
        <table>
          <tr>
            <th>No</th><th>호텔 이름</th><th>성급</th><th class="right">총액</th><th>통화</th><th>환불</th><th>주소</th>
          </tr>
          {% for r in period_rows %}
          <tr>
            <td>{{ r.no }}</td>
            <td>{{ r.name }}</td>
            <td>{{ r.rating }}</td>
            <td class="right">{{ r.price }}</td>
            <td>{{ r.currency }}</td>
            <td>{{ r.refundable }}</td>
            <td>{{ r.address }}</td>
          </tr>
          {% endfor %}
        </table>
      {% endif %}

      <!-- 결과: 호텔(한달) -->
      {% if mode == 'hotel_month' and monthly_results %}
        <h2 class="section-title">호텔 최저가 (한달 스캔) – {{ year }}-{{ '%02d'|format(month) }}</h2>
        {% if hotel_cheapest %}
          <p><b>이 달 호텔 최저가</b>:
            {{ hotel_cheapest.checkin }} ~ {{ hotel_cheapest.checkout }},
            {{ hotel_cheapest.hotelName }} - {{ hotel_cheapest.price }} {{ hotel_cheapest.currency }}
          </p>
        {% endif %}
        <table>
          <tr>
            <th>No</th><th>Checkin</th><th>Checkout</th><th>호텔</th><th class="right">Price</th><th>통화</th>
          </tr>
          {% for r in monthly_results %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ r.checkin }}</td>
            <td>{{ r.checkout }}</td>
            <td>{{ r.hotelName }}</td>
            <td class="right">{{ r.price }}</td>
            <td>{{ r.currency }}</td>
          </tr>
          {% endfor %}
        </table>
      {% endif %}

      <!-- ✅ 결과: 항공+호텔(여행기간) -->
      {% if mode == 'flight_hotel_period' %}
        <h2 class="section-title">항공 + 호텔 (여행기간)</h2>

        {% if best_flight %}
          <h3>① 최저가 항공</h3>
          <ul>
            <li>{{ origin }} → {{ dest }}</li>
            <li>출발일: {{ best_flight.depart_date }}</li>
            {% if best_flight.return_date %}
              <li>귀국일: {{ best_flight.return_date }}</li>
            {% else %}
              <li>편도</li>
            {% endif %}
            <li>항공사: {{ best_flight.airline }}</li>
            <li>가격: {{ best_flight.price_raw }} (추출값: {{ best_flight.price_value|round(0) }})</li>
            {% if flight_price_krw %}
              <li>KRW 환산(추정): {{ flight_price_krw }}</li>
            {% endif %}
          </ul>
        {% else %}
          <p>항공 검색 결과가 없습니다.</p>
        {% endif %}

        {% if fh_hotels %}
          <h3>② 동일 기간 호텔 TOP {{ fh_hotels|length }}</h3>
          <table>
            <tr>
              <th>Rank</th><th>호텔 이름</th><th>성급</th><th class="right">총액</th><th>통화</th><th>환불</th><th>주소</th>
            </tr>
            {% for h in fh_hotels %}
            <tr>
              <td>{{ h.rank }}</td>
              <td>{{ h.name }}</td>
              <td>{{ h.star_rating }}</td>
              <td class="right">{{ h.total_price }}</td>
              <td>{{ h.currency }}</td>
              <td>{{ h.refundable_tag }}</td>
              <td>{{ h.address }}</td>
            </tr>
            {% endfor %}
          </table>

          {% if combined_total and combo_hotel %}
            <h3>③ 항공 + 호텔 합산 최저가 (KRW 기준 추정)</h3>
            <p>
              항공(약 {{ flight_price_krw }}) + 호텔 “{{ combo_hotel.name }}”( {{ combo_hotel.total_price }} ) =
              <b>{{ combined_total }}</b> {{ combo_hotel.currency }}
            </p>
          {% endif %}
        {% else %}
          <p>호텔 검색 결과가 없습니다.</p>
        {% endif %}
      {% endif %}

      <!-- 결과: 항공+호텔(한달) -->
      {% if mode == 'flight_hotel_month' and best_flight %}
        <h2 class="section-title">항공 + 호텔 (한달)</h2>
        <h3>① 이 달 최저가 항공 일정</h3>
        <ul>
          <li>{{ origin }} → {{ dest }}</li>
          <li>출발일: {{ best_flight.depart_date }}</li>
          {% if best_flight.return_date %}
            <li>귀국일: {{ best_flight.return_date }}</li>
          {% else %}
            <li>편도 (체류 {{ nights }}박 기준 호텔 검색)</li>
          {% endif %}
          <li>항공사: {{ best_flight.airline }}</li>
          <li>가격: {{ best_flight.price_raw }} (추출값: {{ best_flight.price_value|round(0) }})</li>
          {% if flight_price_krw %}
            <li>KRW 환산(추정): {{ flight_price_krw }}</li>
          {% endif %}
        </ul>

        {% if fh_hotels %}
          <h3>② 해당 일정 기준 호텔 TOP {{ fh_hotels|length }}</h3>
          <table>
            <tr>
              <th>Rank</th><th>호텔 이름</th><th>성급</th><th class="right">총액</th><th>통화</th><th>환불</th><th>주소</th>
            </tr>
            {% for h in fh_hotels %}
            <tr>
              <td>{{ h.rank }}</td>
              <td>{{ h.name }}</td>
              <td>{{ h.star_rating }}</td>
              <td class="right">{{ h.total_price }}</td>
              <td>{{ h.currency }}</td>
              <td>{{ h.refundable_tag }}</td>
              <td>{{ h.address }}</td>
            </tr>
            {% endfor %}
          </table>

          {% if combined_total and combo_hotel %}
            <h3>③ 항공 + 호텔 합산 최저가 (KRW 기준 추정)</h3>
            <p>
              항공(약 {{ flight_price_krw }}) + 호텔 “{{ combo_hotel.name }}”( {{ combo_hotel.total_price }} ) =
              <b>{{ combined_total }}</b> {{ combo_hotel.currency }}
            </p>
          {% endif %}
        {% else %}
          <p>해당 일정에 대한 호텔 검색 결과가 없습니다.</p>
        {% endif %}
      {% endif %}

    </div>
  </div>

  
  <!-- ===== 코드 카탈로그(국가/IATA) ===== -->
  <div id="catalogOverlay" class="modal-overlay hidden" onclick="closeCatalogOnOverlay(event)">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="catalogTitle" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title" id="catalogTitle">코드 찾기</div>
        <button type="button" class="btn subtle mini modal-close" onclick="closeCatalog()">닫기</button>
      </div>

      <div class="modal-body">
        <div class="modal-tabs">
          <button type="button" id="tab-airport" class="modal-tab" onclick="switchCatalog('airport')">공항 IATA</button>
          <button type="button" id="tab-country" class="modal-tab" onclick="switchCatalog('country')">국가 코드</button>
        </div>

        <div class="catalog-search">
          <input id="catalogQuery" placeholder="검색: 코드 / 도시 / 공항명 / 국가명 (예: ICN, Seoul, Incheon, KR)" oninput="renderCatalog()">
          <button type="button" class="btn mini" onclick="applyFirstMatch()">첫 결과 선택</button>
        </div>

        <div class="catalog-table">
          <table>
            <thead>
              <tr id="catalogHeadRow"></tr>
            </thead>
            <tbody id="catalogBody"></tbody>
          </table>
        </div>

        <div class="code-help">행을 클릭하면 선택한 입력칸에 코드가 자동으로 들어가.</div>
      </div>
    </div>
  </div>

<script>
    // ===== (1) 모드별 입력칸 토글 =====
    function toggleFieldsets(mode){
      const fsPeriod = document.getElementById("fs-period");
      const fsMonth  = document.getElementById("fs-month");
      const fsFlight = document.getElementById("fs-flight");

      if (!fsMonth || !fsFlight || !fsPeriod) return;

      fsPeriod.classList.add("hidden");
      fsMonth.classList.add("hidden");
      fsFlight.classList.add("hidden");

      // 모드별로 필요한 것만 노출
      if (mode === "hotel_period"){
        fsPeriod.classList.remove("hidden");
      } else if (mode === "hotel_month"){
        fsMonth.classList.remove("hidden");
      } else if (mode === "flight_hotel_period"){
        fsPeriod.classList.remove("hidden");
        fsFlight.classList.remove("hidden");
      } else if (mode === "flight_hotel_month"){
        fsMonth.classList.remove("hidden");
        fsFlight.classList.remove("hidden");
      }
    }

    const radios = document.querySelectorAll("input[name='mode']");
    radios.forEach(r => r.addEventListener("change", e => toggleFieldsets(e.target.value)));

    // ===== (2) 코드 자동완성 (Datalist) =====
    // ※ 전체 국가/공항 DB를 다 넣기엔 너무 커서, 자주 쓰는 것 위주로 넣고
    //    필요하면 목록을 더 늘리거나(업데이트), 서버 엔드포인트로 검색형으로 확장 가능.

    const COUNTRIES = [
      { code:"KR", name:"Korea (South)" },
      { code:"JP", name:"Japan" },
      { code:"CN", name:"China" },
      { code:"TW", name:"Taiwan" },
      { code:"HK", name:"Hong Kong" },
      { code:"SG", name:"Singapore" },
      { code:"TH", name:"Thailand" },
      { code:"VN", name:"Vietnam" },
      { code:"MY", name:"Malaysia" },
      { code:"PH", name:"Philippines" },
      { code:"ID", name:"Indonesia" },
      { code:"IN", name:"India" },
      { code:"AE", name:"United Arab Emirates" },
      { code:"SA", name:"Saudi Arabia" },
      { code:"TR", name:"Turkey" },
      { code:"GB", name:"United Kingdom" },
      { code:"FR", name:"France" },
      { code:"DE", name:"Germany" },
      { code:"IT", name:"Italy" },
      { code:"ES", name:"Spain" },
      { code:"NL", name:"Netherlands" },
      { code:"CH", name:"Switzerland" },
      { code:"SE", name:"Sweden" },
      { code:"NO", name:"Norway" },
      { code:"DK", name:"Denmark" },
      { code:"FI", name:"Finland" },
      { code:"AU", name:"Australia" },
      { code:"NZ", name:"New Zealand" },
      { code:"US", name:"United States" },
      { code:"CA", name:"Canada" },
      { code:"MX", name:"Mexico" },
      { code:"BR", name:"Brazil" },
      { code:"AR", name:"Argentina" },
      { code:"CL", name:"Chile" },
      { code:"PE", name:"Peru" },
      { code:"CO", name:"Colombia" }
    ];

    const AIRPORTS = [
      // Korea
      { code:"ICN", city:"Seoul", name:"Incheon International", country:"KR" },
      { code:"GMP", city:"Seoul", name:"Gimpo", country:"KR" },
      { code:"PUS", city:"Busan", name:"Gimhae", country:"KR" },
      { code:"CJU", city:"Jeju", name:"Jeju International", country:"KR" },
      { code:"TAE", city:"Daegu", name:"Daegu International", country:"KR" },
      { code:"CJJ", city:"Cheongju", name:"Cheongju", country:"KR" },
      { code:"RSU", city:"Yeosu", name:"Yeosu", country:"KR" },

      // Japan
      { code:"NRT", city:"Tokyo", name:"Narita", country:"JP" },
      { code:"HND", city:"Tokyo", name:"Haneda", country:"JP" },
      { code:"KIX", city:"Osaka", name:"Kansai", country:"JP" },
      { code:"ITM", city:"Osaka", name:"Itami", country:"JP" },
      { code:"NGO", city:"Nagoya", name:"Chubu Centrair", country:"JP" },
      { code:"CTS", city:"Sapporo", name:"New Chitose", country:"JP" },
      { code:"FUK", city:"Fukuoka", name:"Fukuoka", country:"JP" },
      { code:"OKA", city:"Okinawa", name:"Naha", country:"JP" },

      // China / HK / TW
      { code:"PEK", city:"Beijing", name:"Capital", country:"CN" },
      { code:"PKX", city:"Beijing", name:"Daxing", country:"CN" },
      { code:"PVG", city:"Shanghai", name:"Pudong", country:"CN" },
      { code:"SHA", city:"Shanghai", name:"Hongqiao", country:"CN" },
      { code:"CAN", city:"Guangzhou", name:"Baiyun", country:"CN" },
      { code:"SZX", city:"Shenzhen", name:"Bao'an", country:"CN" },
      { code:"HKG", city:"Hong Kong", name:"Hong Kong Intl", country:"HK" },
      { code:"TPE", city:"Taipei", name:"Taoyuan", country:"TW" },
      { code:"TSA", city:"Taipei", name:"Songshan", country:"TW" },

      // SE Asia
      { code:"BKK", city:"Bangkok", name:"Suvarnabhumi", country:"TH" },
      { code:"DMK", city:"Bangkok", name:"Don Mueang", country:"TH" },
      { code:"SIN", city:"Singapore", name:"Changi", country:"SG" },
      { code:"KUL", city:"Kuala Lumpur", name:"Kuala Lumpur Intl", country:"MY" },
      { code:"HAN", city:"Hanoi", name:"Noi Bai", country:"VN" },
      { code:"SGN", city:"Ho Chi Minh City", name:"Tan Son Nhat", country:"VN" },
      { code:"DAD", city:"Da Nang", name:"Da Nang Intl", country:"VN" },
      { code:"MNL", city:"Manila", name:"Ninoy Aquino", country:"PH" },
      { code:"CEB", city:"Cebu", name:"Mactan–Cebu", country:"PH" },
      { code:"DPS", city:"Bali", name:"Ngurah Rai", country:"ID" },

      // Middle East
      { code:"DXB", city:"Dubai", name:"Dubai Intl", country:"AE" },
      { code:"AUH", city:"Abu Dhabi", name:"Zayed Intl", country:"AE" },
      { code:"DOH", city:"Doha", name:"Hamad Intl", country:"QA" },

      // Europe
      { code:"LHR", city:"London", name:"Heathrow", country:"GB" },
      { code:"LGW", city:"London", name:"Gatwick", country:"GB" },
      { code:"CDG", city:"Paris", name:"Charles de Gaulle", country:"FR" },
      { code:"ORY", city:"Paris", name:"Orly", country:"FR" },
      { code:"FRA", city:"Frankfurt", name:"Frankfurt", country:"DE" },
      { code:"MUC", city:"Munich", name:"Munich", country:"DE" },
      { code:"AMS", city:"Amsterdam", name:"Schiphol", country:"NL" },
      { code:"FCO", city:"Rome", name:"Fiumicino", country:"IT" },
      { code:"MAD", city:"Madrid", name:"Barajas", country:"ES" },
      { code:"BCN", city:"Barcelona", name:"El Prat", country:"ES" },
      { code:"IST", city:"Istanbul", name:"Istanbul", country:"TR" },
      { code:"ZRH", city:"Zurich", name:"Zurich", country:"CH" },

      // USA / Canada
      { code:"JFK", city:"New York", name:"John F. Kennedy", country:"US" },
      { code:"LGA", city:"New York", name:"LaGuardia", country:"US" },
      { code:"EWR", city:"Newark", name:"Newark Liberty", country:"US" },
      { code:"LAX", city:"Los Angeles", name:"Los Angeles Intl", country:"US" },
      { code:"SFO", city:"San Francisco", name:"San Francisco Intl", country:"US" },
      { code:"SEA", city:"Seattle", name:"Seattle–Tacoma", country:"US" },
      { code:"ORD", city:"Chicago", name:"O'Hare", country:"US" },
      { code:"DFW", city:"Dallas", name:"Dallas/Fort Worth", country:"US" },
      { code:"YYZ", city:"Toronto", name:"Pearson", country:"CA" },
      { code:"YVR", city:"Vancouver", name:"Vancouver Intl", country:"CA" }
    ];

    function fillDatalist(id, rows, formatter){
      const dl = document.getElementById(id);
      if (!dl) return;
      dl.innerHTML = "";
      rows.forEach(r => {
        const opt = document.createElement("option");
        opt.value = formatter(r);
        dl.appendChild(opt);
      });
    }

    function normalizeCodeInput(el){
      if (!el) return;
      const v = (el.value || "").trim();
      const parts = v.split(" - ");
      if (parts.length >= 2) el.value = parts[0].trim();
    }

    // ===== (3) 카탈로그 모달 =====
    let catalogMode = "airport";   // 'airport' | 'country'
    let catalogTargetId = null;    // input id to fill

    function openCatalog(mode, targetId){
      catalogMode = mode;
      catalogTargetId = targetId;

      const overlay = document.getElementById("catalogOverlay");
      if (!overlay) return;
      overlay.classList.remove("hidden");

      // 탭 상태
      switchCatalog(mode);

      const q = document.getElementById("catalogQuery");
      if (q){
        q.value = "";
        q.focus();
      }
      renderCatalog();
    }

    function closeCatalog(){
      const overlay = document.getElementById("catalogOverlay");
      if (!overlay) return;
      overlay.classList.add("hidden");
      catalogTargetId = null;
    }

    function closeCatalogOnOverlay(e){
      // overlay 클릭 시 닫기
      if (e.target && e.target.id === "catalogOverlay") closeCatalog();
    }

    function switchCatalog(mode){
      catalogMode = mode;
      const tabA = document.getElementById("tab-airport");
      const tabC = document.getElementById("tab-country");
      if (tabA && tabC){
        tabA.classList.toggle("active", mode === "airport");
        tabC.classList.toggle("active", mode === "country");
      }
      renderCatalogHead();
      renderCatalog();
    }

    function renderCatalogHead(){
      const head = document.getElementById("catalogHeadRow");
      if (!head) return;

      if (catalogMode === "airport"){
        head.innerHTML = "<th>코드</th><th>도시</th><th>공항</th><th>국가</th>";
      } else {
        head.innerHTML = "<th>코드</th><th>국가명</th>";
      }
    }

    function getCatalogQuery(){
      const q = document.getElementById("catalogQuery");
      return (q?.value || "").trim().toLowerCase();
    }

    function renderCatalog(){
      const body = document.getElementById("catalogBody");
      if (!body) return;
      const q = getCatalogQuery();

      let rows = [];
      if (catalogMode === "airport"){
        rows = AIRPORTS.filter(a => {
          if (!q) return true;
          return (
            a.code.toLowerCase().includes(q) ||
            a.city.toLowerCase().includes(q) ||
            a.name.toLowerCase().includes(q) ||
            a.country.toLowerCase().includes(q)
          );
        }).slice(0, 200);

        body.innerHTML = rows.map(a => `
          <tr onclick="pickCatalogValue('${a.code}')">
            <td><b>${a.code}</b></td>
            <td>${a.city}</td>
            <td>${a.name}</td>
            <td>${a.country}</td>
          </tr>
        `).join("");

      } else {
        rows = COUNTRIES.filter(c => {
          if (!q) return true;
          return (
            c.code.toLowerCase().includes(q) ||
            c.name.toLowerCase().includes(q)
          );
        }).slice(0, 200);

        body.innerHTML = rows.map(c => `
          <tr onclick="pickCatalogValue('${c.code}')">
            <td><b>${c.code}</b></td>
            <td>${c.name}</td>
          </tr>
        `).join("");
      }
    }

    function pickCatalogValue(code){
      if (!catalogTargetId) return;
      const el = document.getElementById(catalogTargetId);
      if (!el) return;
      el.value = code;
      closeCatalog();
    }

    function applyFirstMatch(){
      const q = getCatalogQuery();
      if (catalogMode === "airport"){
        const a = AIRPORTS.find(x =>
          !q ||
          x.code.toLowerCase().includes(q) ||
          x.city.toLowerCase().includes(q) ||
          x.name.toLowerCase().includes(q) ||
          x.country.toLowerCase().includes(q)
        );
        if (a) pickCatalogValue(a.code);
      } else {
        const c = COUNTRIES.find(x => !q || x.code.toLowerCase().includes(q) || x.name.toLowerCase().includes(q));
        if (c) pickCatalogValue(c.code);
      }
    }

    // ===== 초기화 =====
    document.addEventListener("DOMContentLoaded", () => {
      // datalist 채우기
      fillDatalist("country-list", COUNTRIES, c => `${c.code} - ${c.name}`);
      fillDatalist("airport-list", AIRPORTS, a => `${a.code} - ${a.city} / ${a.name} (${a.country})`);

      // 선택했을 때 코드만 남기기
      ["country","origin","dest"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("change", () => normalizeCodeInput(el));
        el.addEventListener("blur", () => normalizeCodeInput(el));
      });

      // 토글 초기 로딩
      toggleFieldsets("{{ mode }}");
      renderCatalogHead();

      // ESC로 닫기
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape"){
          const overlay = document.getElementById("catalogOverlay");
          if (overlay && !overlay.classList.contains("hidden")) closeCatalog();
        }
      });
    });
</script>

<script>
  // Keep checkout >= checkin for better UX
  function syncCheckoutMin(){
    const ci = document.querySelector('input[name="checkin"]');
    const co = document.querySelector('input[name="checkout"]');
    if(!ci || !co) return;
    if(ci.value) co.min = ci.value;
    if(ci.value && co.value && co.value < ci.value){
      co.value = ci.value;
    }
  }
  document.addEventListener("DOMContentLoaded", () => {
    syncCheckoutMin();
    const ci = document.querySelector('input[name="checkin"]');
    const co = document.querySelector('input[name="checkout"]');
    if(ci) ci.addEventListener("change", syncCheckoutMin);
    if(co) co.addEventListener("change", syncCheckoutMin);
  });
</script>

</body>
</html>

{% endblock %}
