{% extends "base.html" %}
{% block content %}

<section class="section">
  <div class="section-head">
    <h2>여행툴</h2>
    <p class="muted">항공 + 호텔 최저가 웹툴</p>
  </div>

  <div class="card">
    <form method="post" class="form">
      <fieldset>
        <legend>검색 모드</legend>
        <div class="mode-select">
          <label><input type="radio" name="mode" value="hotel_period" {{ 'checked' if mode == 'hotel_period' else '' }}> 호텔 최저가 (여행기간)</label>
          <label><input type="radio" name="mode" value="hotel_month" {{ 'checked' if mode == 'hotel_month' else '' }}> 호텔 최저가 (한달)</label>
          <label><input type="radio" name="mode" value="flight_hotel_month" {{ 'checked' if mode == 'flight_hotel_month' else '' }}> 항공 + 호텔 (한달 최저가)</label>
        </div>
      </fieldset>

      <fieldset>
        <legend>호텔 공통 설정</legend>
        <div class="grid2">
          <label>도시 (cityName)
            <input name="city" value="{{ city }}">
          </label>
          <label>국가코드 (countryCode)
            <input name="country" value="{{ country }}" maxlength="4">
          </label>
          <label>성인 인원수
            <input name="adults" value="{{ adults }}">
          </label>
          <label>통화
            <input name="currency" value="{{ currency }}" maxlength="5">
          </label>
          <label>최소 성급
            <input name="min_stars" value="{{ min_stars }}">
          </label>
          <label>최대 성급
            <input name="max_stars" value="{{ max_stars }}">
          </label>
          <label>국적
            <input name="guest_nat" value="{{ guest_nat }}" maxlength="4">
          </label>
        </div>
      </fieldset>

      <fieldset>
        <legend>호텔 최저가 (여행기간)</legend>
        <div class="grid2">
          <label>체크인 (YYYY-MM-DD)
            <input name="checkin" value="{{ checkin }}">
          </label>
          <label>체크아웃 (YYYY-MM-DD)
            <input name="checkout" value="{{ checkout }}">
          </label>
          <label>Top N
            <input name="top_n" value="{{ top_n }}">
          </label>
          <label>Limit
            <input name="limit" value="{{ limit }}">
          </label>
        </div>
      </fieldset>

      <fieldset>
        <legend>호텔 / 항공 한달 검색 공통</legend>
        <div class="grid2">
          <label>기준 연도
            <input name="year" value="{{ year }}">
          </label>
          <label>기준 월
            <input name="month" value="{{ month }}">
          </label>
          <label>숙박일수(박)
            <input name="nights" value="{{ nights }}">
          </label>
        </div>
      </fieldset>

      <fieldset>
        <legend>항공 설정 (항공 + 호텔 모드에서 사용)</legend>
        <div class="grid2">
          <label>출발 공항 (IATA)
            <input name="origin" value="{{ origin }}" maxlength="5">
          </label>
          <label>도착 공항 (IATA)
            <input name="dest" value="{{ dest }}" maxlength="5">
          </label>

          <label>여정 타입
            <select name="trip">
              <option value="round-trip" {% if trip == 'round-trip' %}selected{% endif %}>왕복</option>
              <option value="one-way" {% if trip == 'one-way' %}selected{% endif %}>편도</option>
            </select>
          </label>

          <label>좌석 등급
            <select name="seat">
              <option value="economy" {% if seat == 'economy' %}selected{% endif %}>Economy</option>
              <option value="premium_economy" {% if seat == 'premium_economy' %}selected{% endif %}>Premium Economy</option>
              <option value="business" {% if seat == 'business' %}selected{% endif %}>Business</option>
              <option value="first" {% if seat == 'first' %}selected{% endif %}>First</option>
            </select>
          </label>

          <label>항공 검색 인원수
            <input name="flight_adults" value="{{ flight_adults }}">
          </label>

          <label>호텔 TOP N (항공+호텔 모드)
            <input name="fh_top_n" value="{{ fh_top_n }}">
          </label>
        </div>
      </fieldset>

      <div class="form-actions">
        <button class="btn" type="submit">검색하기</button>
      </div>
    </form>
  </div>

  {% if error %}
    <div class="card errorbox">에러: {{ error }}</div>
  {% endif %}

  {% if mode == 'hotel_period' and period_rows %}
    <div class="card">
      <h3 class="section-title">호텔 최저가 (여행기간) 결과</h3>
      <div class="table-wrap">
        <table>
          <tr>
            <th>No</th><th>호텔 이름</th><th>성급</th><th>총액</th><th>통화</th><th>환불여부</th><th>주소</th>
          </tr>
          {% for r in period_rows %}
          <tr>
            <td>{{ r.no }}</td>
            <td>{{ r.name }}</td>
            <td>{{ r.rating }}</td>
            <td class="num">{{ r.price }}</td>
            <td>{{ r.currency }}</td>
            <td>{{ r.refundable }}</td>
            <td>{{ r.address }}</td>
          </tr>
          {% endfor %}
        </table>
      </div>
    </div>
  {% endif %}

  {% if mode == 'hotel_month' and monthly_results %}
    <div class="card">
      <h3 class="section-title">호텔 최저가 (한달 스캔) 결과 – {{ year }}-{{ '%02d'|format(month) }}</h3>

      {% if hotel_cheapest %}
        <p class="muted" style="margin-top:0;">
          <strong>이 달 호텔 최저가</strong>:
          {{ hotel_cheapest.checkin }} ~ {{ hotel_cheapest.checkout }},
          {{ hotel_cheapest.hotelName }} - {{ hotel_cheapest.price }} {{ hotel_cheapest.currency }}
        </p>
      {% endif %}

      <div class="table-wrap">
        <table>
          <tr>
            <th>No</th><th>Checkin</th><th>Checkout</th><th>호텔</th><th>Price</th><th>통화</th>
          </tr>
          {% for r in monthly_results %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ r.checkin }}</td>
            <td>{{ r.checkout }}</td>
            <td>{{ r.hotelName }}</td>
            <td class="num">{{ r.price }}</td>
            <td>{{ r.currency }}</td>
          </tr>
          {% endfor %}
        </table>
      </div>
    </div>
  {% endif %}

  {% if mode == 'flight_hotel_month' and best_flight %}
    <div class="card">
      <h3 class="section-title">한달 기준 항공 + 호텔 최저가</h3>

      <h4>① 이 달 최저가 항공 일정</h4>
      <ul class="list">
        <li>출발 공항: {{ origin }} → 도착 공항: {{ dest }}</li>
        <li>출발일: {{ best_flight.depart_date }}</li>
        {% if best_flight.return_date %}
          <li>귀국일: {{ best_flight.return_date }}</li>
        {% else %}
          <li>편도 (체류 {{ nights }}박 기준 호텔 검색)</li>
        {% endif %}
        <li>항공사: {{ best_flight.airline }}</li>
        <li>가격: {{ best_flight.price_raw }} (추출값: {{ best_flight.price_value|round(0) }})</li>
      </ul>

      {% if fh_hotels %}
        <h4>② 해당 일정 기준 호텔 최저가 TOP {{ fh_hotels|length }}</h4>
        <div class="table-wrap">
          <table>
            <tr>
              <th>Rank</th><th>호텔 이름</th><th>성급</th><th>총액</th><th>통화</th><th>환불여부</th><th>주소</th>
            </tr>
            {% for h in fh_hotels %}
            <tr>
              <td>{{ h.rank }}</td>
              <td>{{ h.name }}</td>
              <td>{{ h.star_rating }}</td>
              <td class="num">{{ h.total_price }}</td>
              <td>{{ h.currency }}</td>
              <td>{{ h.refundable_tag }}</td>
              <td>{{ h.address }}</td>
            </tr>
            {% endfor %}
          </table>
        </div>

        {% if combined_total and combo_hotel %}
          <h4>③ 항공 + 호텔 합산 최저가</h4>
          <p class="muted">
            항공 (약 {{ best_flight.price_value|round(0) }}) +
            호텔 “{{ combo_hotel.name }}” ({{ combo_hotel.total_price }}) =
            <strong>{{ combined_total|round(0) }}</strong>
            {{ combo_hotel.currency }} (동일 통화 기준 추정)
          </p>
        {% endif %}
      {% else %}
        <p class="muted">해당 일정에 대한 호텔 검색 결과가 없습니다.</p>
      {% endif %}
    </div>
  {% endif %}

</section>
{% endblock %}
